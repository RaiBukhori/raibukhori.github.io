<!doctypehtml><style>body{background:#111;color:#ddd;font-family:monospace;padding:10px;line-height:1.5}.container{max-width:800px;margin:0 auto}h1{color:#0f0;margin-bottom:25px}h4{color:#0f0;margin-top:25px;margin-bottom:10px}.stream-info h3{color:#0f0;margin:0 0 5px 0;font-size:1.1em}button,input{background:#222;color:#ddd;border:1px solid #555;padding:8px 12px;font-family:monospace;margin:0}button{cursor:pointer}button:disabled{color:#777;cursor:not-allowed}.input-group{display:flex;margin-bottom:25px}#mpdUrl{flex-grow:1}#fetchButton{display:flex;align-items:center;gap:8px}.loader{width:14px;height:14px;border:2px solid #555;border-top-color:#ddd;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}#streamsContainer{margin-bottom:15px}.stream-card{border:1px solid #333;padding:12px;margin-bottom:10px;background-color:#1a1a1a}.stream-info p{margin:0;font-size:.9em;color:#bbb}.download-button{margin-top:12px;background-color:#004d00}#progressLog{background:#000;border:1px solid #555;padding:10px;height:250px;overflow-y:auto;white-space:pre-wrap;word-break:break-all}.log-entry{margin-bottom:4px}.log-entry.error{color:#f55}.log-entry.success{color:#5f5}.log-entry.warning{color:#f90}.important-note{background-color:#220;border:1px solid #553;padding:12px;margin-top:20px}.important-note h4{margin-top:0}.important-note code{background-color:#000;padding:2px 4px}@media (max-width:600px){.input-group{flex-direction:column;gap:10px}}</style><div class=container><h1>MPEG-DASH Downloader</h1><div class=input-group><input id=mpdUrl placeholder=https://.../manifest.mpd><button id=fetchButton><span id=fetchButtonText>Fetch</span><div class=loader id=loader style=display:none></div></button></div><div id=streamsContainer></div><h4>Process Log</h4><div id=progressLog></div><div class=important-note><h4>Important: Separated Files</h4><p>This tool downloads video and audio files separately. To combine them into a single file, use FFmpeg on your computer with the command:<p><code>ffmpeg -i video_name.mp4 -i audio_name.m4a -c copy final_video.mp4</code></div></div><script src=https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js></script><script>const mpdUrlInput=document.getElementById("mpdUrl"),fetchButton=document.getElementById("fetchButton"),fetchButtonText=document.getElementById("fetchButtonText"),loader=document.getElementById("loader"),streamsContainer=document.getElementById("streamsContainer"),progressLog=document.getElementById("progressLog");let allRepresentations=[];const downloadStates={},MAX_LOG_ENTRIES=200;function log(e,t="info"){progressLog.children.length>=200&&progressLog.removeChild(progressLog.firstChild);const n=document.createElement("div");n.className=`log-entry ${t}`,n.textContent=`[${(new Date).toLocaleTimeString()}] ${e}`,progressLog.appendChild(n),progressLog.scrollTop=progressLog.scrollHeight}function displayStreams(){streamsContainer.innerHTML="",allRepresentations.forEach(((e,t)=>{const n=document.createElement("div");n.className="stream-card";let o=`Codec: ${e.codecs}, Bitrate: ${Math.round(e.bandwidth/1e3)} kbps`;"video"===e.type&&(o+=`, Resolution: ${e.width}x${e.height}`),n.innerHTML=`\n <div class="stream-info">\n <h3>${"video"===e.type?"Video":"Audio"} - ${e.id}</h3>\n <p>${o}</p>\n </div>\n <button class="download-button" data-index="${t}" onclick="handleDownloadClick(${t})">Download</button>\n `,streamsContainer.appendChild(n)}))}function handleDownloadClick(e){downloadStates[e]||(downloadStates[e]={isDownloading:!1,isPaused:!1,pausedForNetwork:!1,nextSegmentIndex:0,segmentUrls:[],abortController:null,writer:null});const t=downloadStates[e],n=document.querySelector(`.download-button[data-index='${e}']`);t.isDownloading&&!t.isPaused?(t.isPaused=!0,t.abortController&&t.abortController.abort(),n.textContent="Resume",log(`Download for stream ${allRepresentations[e].id} paused by user.`,"warning")):(t.isPaused=!1,t.pausedForNetwork=!1,startOrResumeDownload(e))}async function startOrResumeDownload(e){const t=allRepresentations[e],n=downloadStates[e],o=document.querySelector(`.download-button[data-index='${e}']`);n.isDownloading=!0,n.isPaused=!1,o.disabled=!0,o.textContent="Starting...";try{if(0===n.nextSegmentIndex){log(`Starting download for stream: ${t.id}`),await prepareSegmentUrls(e);const o="video"===t.type?"mp4":"m4a",r=`${t.type}_${t.id}_${t.width||""}x${t.height||t.bandwidth/1e3+"kbps"}.${o}`,a=streamSaver.createWriteStream(r);n.writer=a.getWriter(),await downloadAndWriteInitSegment(e)}else log(`Resuming download for stream: ${t.id} from segment ${n.nextSegmentIndex+1}`,"info");for(let e=n.nextSegmentIndex;e<n.segmentUrls.length;e++){if(n.isPaused){log(`Download paused at segment ${e+1}.`,"warning");break}n.abortController=new AbortController;const t=n.segmentUrls[e];o.textContent=`Downloading (Click to Pause) (${e+1}/${n.segmentUrls.length})`,o.disabled=!1;try{log(`Downloading segment ${e+1}/${n.segmentUrls.length}: ${t.split("/").pop()}`);const o=await fetch(t,{signal:n.abortController.signal});if(!o.ok){log(`Segment ${e+1} not found (status ${o.status}), process stopped.`,"error");break}const r=await o.arrayBuffer();await n.writer.write(new Uint8Array(r)),n.nextSegmentIndex=e+1}catch(t){if("AbortError"===t.name)break;if(t instanceof TypeError&&"Failed to fetch"===t.message){log(`Network error on segment ${e+1}. Download paused.`,"error"),n.isPaused=!0,n.pausedForNetwork=!0,o.textContent="Paused (Offline)";break}log(`Failed to download segment ${e+1}: ${t.message}. This might be the end of the stream.`,"warning");break}}n.nextSegmentIndex!==n.segmentUrls.length||n.isPaused||(log(`Finalizing file for ${t.id}...`),await n.writer.close(),log(`Download for ${t.id} complete!`,"success"),o.textContent="Complete",o.disabled=!0,n.isDownloading=!1)}catch(e){log(`Failed to download stream ${t.id}: ${e.message}`,"error"),console.error(e),o.textContent="Failed",o.disabled=!0,n.isDownloading=!1,n.writer&&n.writer.abort(e)}finally{n.isPaused||n.isDownloading?n.isPaused&&(o.disabled=!1):o.disabled=!0}}function resolveUrl(e,t){try{return!t||t.startsWith("http://")||t.startsWith("https://")?t:new URL(t,e).href}catch(n){return console.error(`Could not resolve URL for base: ${e} and path: ${t}`),t}}async function downloadAndWriteInitSegment(e){const t=allRepresentations[e],n=downloadStates[e],{initialization:o}=t.segmentInfo;if(o){const e=o.replace(/\$RepresentationID\$/g,t.id).replace(/\$Bandwidth\$/g,t.bandwidth),r=resolveUrl(t.baseUrl,e);log(`Downloading initialization segment: ${r}`);const a=await fetch(r);if(!a.ok)throw new Error("Failed to download initialization segment.");const s=await a.arrayBuffer();await n.writer.write(new Uint8Array(s))}}async function prepareSegmentUrls(e){const t=allRepresentations[e],n=downloadStates[e],{media:o,timescale:r,duration:a,startNumber:s,segmentTimeline:i}=t.segmentInfo;let l=[];if(i&&i.length>0){let e=0,n=s;i.forEach((r=>{e=void 0!==r.t?r.t:e;for(let a=0;a<=r.r;a++){let a=o.replace(/\$RepresentationID\$/g,t.id).replace(/\$Bandwidth\$/g,t.bandwidth).replace(/\$Time\$/g,e);const s=a.match(/\$Number(%0(\d)d)\$/);a=s?a.replace(s[0],String(n).padStart(parseInt(s[2],10),"0")):a.replace(/\$Number\$/g,n),l.push(resolveUrl(t.baseUrl,a)),e+=r.d,n++}}))}else{const e=t.parentSet.closest("Period")?.getAttribute("duration");if(!e||!a||!r)throw new Error("Could not determine the number of segments from the manifest.");const n=/PT(?:(\d+)H)?(?:(\d+)M)?(?:([\d.]+)S)?/,i=e.match(n),d=3600*parseFloat(i[1]||0)+60*parseFloat(i[2]||0)+parseFloat(i[3]||0),g=a/r,c=Math.ceil(d/g);log(`Estimated total segments: ${c}`);for(let e=s;e<s+c;e++){let n=o.replace(/\$RepresentationID\$/g,t.id).replace(/\$Bandwidth\$/g,t.bandwidth);const r=n.match(/\$Number(%0(\d)d)\$/);n=r?n.replace(r[0],String(e).padStart(parseInt(r[2],10),"0")):n.replace(/\$Number\$/g,e),l.push(resolveUrl(t.baseUrl,n))}}n.segmentUrls=l}fetchButton.addEventListener("click",(async()=>{const e=mpdUrlInput.value.trim();if(e){streamsContainer.innerHTML="",progressLog.innerHTML="",allRepresentations=[],Object.keys(downloadStates).forEach((e=>delete downloadStates[e])),fetchButton.disabled=!0,fetchButtonText.textContent="Processing...",loader.style.display="block";try{log(`Fetching manifest from: ${e}`);const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch manifest: Status ${t.status}`);const n=await t.text();log("Manifest fetched successfully. Parsing XML...");const o=(new DOMParser).parseFromString(n,"application/xml");if(o.getElementsByTagName("parsererror").length>0)throw new Error("Failed to parse manifest XML.");const r=o.querySelector("BaseURL"),a=r?new URL(r.textContent,e).href:new URL(".",e).href,s=o.querySelectorAll("AdaptationSet");if(log(`Found ${s.length} AdaptationSet(s).`),s.forEach((e=>{const t=e.getAttribute("mimeType")||"",n=e.getAttribute("contentType")||t.split("/")[0]||"unknown";e.querySelectorAll("Representation").forEach((t=>{const o={id:t.getAttribute("id"),codecs:t.getAttribute("codecs"),bandwidth:parseInt(t.getAttribute("bandwidth"),10),width:t.getAttribute("width"),height:t.getAttribute("height"),type:n,baseUrl:a,segmentInfo:null,parentSet:e},r=t.querySelector("SegmentTemplate")||e.querySelector("SegmentTemplate");if(r)o.segmentInfo={type:"template",initialization:r.getAttribute("initialization"),media:r.getAttribute("media"),timescale:parseInt(r.getAttribute("timescale"),10),duration:parseInt(r.getAttribute("duration"),10),startNumber:parseInt(r.getAttribute("startNumber")||"1",10),segmentTimeline:Array.from(r.querySelectorAll("S")).map((e=>({t:e.getAttribute("t")?parseInt(e.getAttribute("t"),10):void 0,d:parseInt(e.getAttribute("d"),10),r:parseInt(e.getAttribute("r")||"0",10)})))};else{const n=t.querySelector("SegmentBase")||e.querySelector("SegmentBase");if(n){const e=n.querySelector("Initialization");o.segmentInfo={type:"base",indexRange:n.getAttribute("indexRange"),initializationRange:e?e.getAttribute("range"):null,sourceURL:a}}}o.segmentInfo&&allRepresentations.push(o)}))})),0===allRepresentations.length)throw new Error("No processable streams found in the manifest.");log(`Parsing successful. Found ${allRepresentations.length} valid streams.`),displayStreams()}catch(e){log(`An error occurred: ${e.message}`,"error"),console.error(e)}finally{fetchButton.disabled=!1,fetchButtonText.textContent="Fetch",loader.style.display="none"}}else log("MPD URL cannot be empty.","error")})),window.addEventListener("offline",(()=>{log("Network connection lost. Active downloads paused.","error")})),window.addEventListener("online",(()=>{log("Network connection restored. Attempting to resume downloads...","success");for(const e in downloadStates){const t=downloadStates[e];t.pausedForNetwork&&(log(`Auto-resuming download for stream ${allRepresentations[e].id}.`,"info"),t.pausedForNetwork=!1,startOrResumeDownload(e))}}))</script>
